<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tor P2P Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin:0; font-family:monospace;
      background:url("https://i.ibb.co/hJLBdMNx/temp.jpg") no-repeat center center fixed;
      background-size:cover; color:#0f0;
      height:100vh; display:flex; justify-content:center; align-items:center;
    }
    .glass{background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);
      border:1px solid rgba(0,255,0,0.4); border-radius:10px;
      padding:20px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,255,0,0.4);}
    input,button{width:100%;padding:10px;margin:8px 0;border:none;
      border-radius:5px;background:rgba(20,20,20,0.85);color:#0f0;font-family:inherit;}
    button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
    .chat-container{display:none;flex-direction:column;height:90vh;width:95%;max-width:600px;}
    .header{text-align:right;margin-bottom:5px;font-size:13px;opacity:0.8;}
    .messages{flex:1;overflow-y:auto;margin-bottom:10px;padding:10px;
      background:rgba(0,0,0,0.65);border-radius:8px;}
    .msg{margin:5px 0;padding:6px 10px;border-radius:6px;word-wrap:break-word;}
    .input-area{display:flex;flex-direction:column;gap:10px;}
  </style>
</head>
<body>

  <div class="glass" id="login">
    <input type="text" id="nickname" placeholder="Display name">
    <button onclick="joinRoom()">Join</button>
  </div>

  <div class="chat-container" id="chat">
    <div class="header">Online: <span id="userCount">1</span></div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

<!-- Firebase & CryptoJS -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAcaZQFO9IOUt60hhKjG2K2eVkV1kHXf1M",
    authDomain: "chat-room-9f262.firebaseapp.com",
    projectId: "chat-room-9f262",
    storageBucket: "chat-room-9f262.firebasestorage.app",
    messagingSenderId: "454201377123",
    appId: "1:454201377123:web:1a2cb2875345385a701356"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Chat Variables ---
  let nickname, userColor; 
  let usersOnline = 1;

  // --- Random Color ---
  function getRandomColor(){
    const c=["#0f0","#0ff","#f0f","#ff0","#f00","#0a0","#08f","#fa0"];
    return c[Math.floor(Math.random()*c.length)];
  }

  // --- Double Encryption ---
  const SECRET1 = "firstSecretKey123";
  const SECRET2 = "secondSecretKey456";

  function doubleEncrypt(message){
    const first = CryptoJS.AES.encrypt(message, SECRET1).toString();
    const second = CryptoJS.AES.encrypt(first, SECRET2).toString();
    return second;
  }

  function doubleDecrypt(cipher){
    try{
      const first = CryptoJS.AES.decrypt(cipher, SECRET2).toString(CryptoJS.enc.Utf8);
      const second = CryptoJS.AES.decrypt(first, SECRET1).toString(CryptoJS.enc.Utf8);
      return second;
    }catch{return "[Unable to decrypt]";}
  }

  // --- Join Room ---
  async function joinRoom(){
    nickname=document.getElementById("nickname").value||"Anonymous";
    userColor=getRandomColor();
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="flex";

    // Real-time messages listener
    db.collection("messages").orderBy("timestamp","asc")
      .onSnapshot(snapshot => {
        document.getElementById("messages").innerHTML = ""; // clear and reload
        snapshot.forEach(doc => {
          const data = doc.data();
          const text = doubleDecrypt(data.text);
          displayMessage(text, data.color);
        });
      });

    // Start updating online users
    setInterval(updateOnlineUsers, 2000);
  }

  // --- Send Message ---
  async function sendMessage(){
    const input=document.getElementById("messageInput"); 
    const text=input.value.trim();
    if(!text) return;

    const messageObj = {
      text: doubleEncrypt(nickname+": "+text),
      color: userColor,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("messages").add(messageObj);
    input.value="";
  }

  // --- Display Message ---
  function displayMessage(text,color){
    const div=document.createElement("div"); 
    div.classList.add("msg");
    div.style.background=color+"20"; 
    div.style.borderLeft="4px solid "+color;
    div.textContent=text; 
    document.getElementById("messages").appendChild(div);
    const m=document.getElementById("messages"); 
    m.scrollTop=m.scrollHeight;
  }

  // --- Online Users Tracking ---
  async function updateOnlineUsers(){
    const userRef = db.collection("online").doc(nickname);
    await userRef.set({timestamp: firebase.firestore.FieldValue.serverTimestamp()});

    const now = new Date();
    const snapshot = await db.collection("online")
      .where("timestamp", ">", new Date(now.getTime() - 5000))
      .get();

    usersOnline = snapshot.size;
    document.getElementById("userCount").textContent = usersOnline;
  }

</script>
</body>
                                                                                       </html>
